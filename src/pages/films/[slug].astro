---
import BaseLayout from '../../layouts/BaseLayout.astro';
import QuoteBlock from '../../components/QuoteBlock.astro';
import { getFilms, getFilmBySlug, getPicksForFilm, getGuestByName, getBoxSetInfoForFilm, getGuestBySlug } from '../../lib/data';

export function getStaticPaths() {
  const films = getFilms();
  return films.map((film) => ({
    params: { slug: film.slug },
  }));
}

const { slug } = Astro.params;
const film = getFilmBySlug(slug!);

if (!film) {
  return Astro.redirect('/films/');
}

const allPicks = getPicksForFilm(film.slug);
const directPicks = allPicks.filter(p => !p.box_set_film_count);
const boxSetPicks = allPicks.filter(p => p.box_set_film_count);
const boxSetInfo = getBoxSetInfoForFilm(film.slug);
---
<BaseLayout title={film.title} description={`${film.title} (${film.year}) directed by ${film.director} â€” picked by ${film.pick_count} Criterion Closet guests.`}>
  <div class="detail-page">
    <div class="detail-header">
      {film.poster_url ? (
        <img src={film.poster_url} alt={film.title} class="film-poster-large" loading="lazy" />
      ) : film.criterion_spine_number ? (
        <div class="spine-placeholder" style="width: 185px; height: 278px; font-size: 2rem;">
          #{film.criterion_spine_number}
        </div>
      ) : null}
      <div class="detail-meta">
        <h1 style="margin-top: 0;">{film.title}</h1>
        <p class="text-secondary" style="font-size: 1.1rem; margin-bottom: 0.5rem;">
          {film.director ? `${film.director}, ${film.year}` : film.year}
        </p>
        {film.criterion_spine_number && (
          <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 0.5rem;">
            Spine <span class="spine-number">#{film.criterion_spine_number}</span>
          </p>
        )}
        <p style="margin-bottom: 0.5rem;">
          <span class="badge">
            Picked by {film.pick_count} {film.pick_count === 1 ? 'guest' : 'guests'}
          </span>
        </p>
        {film.genres.length > 0 && (
          <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">
            {film.genres.join(' / ')}
          </p>
        )}
        {boxSetInfo.length > 0 && boxSetInfo.map((bs) => (
          <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">
            Part of {bs.criterion_url ? (
              <a href={bs.criterion_url} target="_blank" rel="noopener noreferrer">{bs.name}</a>
            ) : (
              <span>{bs.name}</span>
            )}
          </p>
        ))}
        <div class="detail-links">
          {film.criterion_url && (
            <a href={film.criterion_url} target="_blank" rel="noopener noreferrer">
              Criterion
            </a>
          )}
          {film.tmdb_url && (
            <a href={film.tmdb_url} target="_blank" rel="noopener noreferrer">
              TMDB
            </a>
          )}
        </div>
      </div>
    </div>

    {film.credits && (
      <div class="film-credits">
        {film.credits.directors.length > 0 && (
          <p>
            <span class="credit-label">Directed by</span>{' '}
            {film.credits.directors.map((d, i) => {
              const guest = getGuestByName(d.name);
              return (
                <>
                  {i > 0 && ', '}
                  {guest ? <a href={`/guests/${guest.slug}/`}>{d.name}</a> : d.name}
                </>
              );
            })}
          </p>
        )}
        {film.credits.writers.length > 0 && (
          <p>
            <span class="credit-label">Written by</span>{' '}
            {film.credits.writers.map((w, i) => {
              const guest = getGuestByName(w.name);
              return (
                <>
                  {i > 0 && ', '}
                  {guest ? <a href={`/guests/${guest.slug}/`}>{w.name}</a> : w.name}
                </>
              );
            })}
          </p>
        )}
        {film.credits.cinematographers.length > 0 && (
          <p>
            <span class="credit-label">Cinematography</span>{' '}
            {film.credits.cinematographers.map((c, i) => {
              const guest = getGuestByName(c.name);
              return (
                <>
                  {i > 0 && ', '}
                  {guest ? <a href={`/guests/${guest.slug}/`}>{c.name}</a> : c.name}
                </>
              );
            })}
          </p>
        )}
        {film.credits.editors.length > 0 && (
          <p>
            <span class="credit-label">Edited by</span>{' '}
            {film.credits.editors.map((e, i) => {
              const guest = getGuestByName(e.name);
              return (
                <>
                  {i > 0 && ', '}
                  {guest ? <a href={`/guests/${guest.slug}/`}>{e.name}</a> : e.name}
                </>
              );
            })}
          </p>
        )}
        {film.credits.cast.length > 0 && (
          <p>
            <span class="credit-label">Cast</span>{' '}
            {film.credits.cast.map((c, i) => {
              const guest = getGuestByName(c.name);
              return (
                <>
                  {i > 0 && ', '}
                  {guest ? <a href={`/guests/${guest.slug}/`}>{c.name}</a> : c.name}
                </>
              );
            })}
          </p>
        )}
      </div>
    )}

    <h2>Picked by</h2>

    <div class="picks-list">
      {directPicks.map((pick) => (
        <div>
          <div class="pick-guest-header">
            {pick.guest?.photo_url ? (
              <img src={pick.guest.photo_url} alt={pick.guest.name} class="guest-photo-small" loading="lazy" />
            ) : (
              <div class="guest-initial-small">
                {pick.guest?.name?.charAt(0) || '?'}
              </div>
            )}
            <div>
              <a href={`/guests/${pick.guest_slug}/`} style="font-size: 1.05rem;">
                {pick.guest?.name || pick.guest_slug}
              </a>
              {pick.guest?.profession && (
                <span class="small-caps text-secondary" style="margin-left: 0.5rem; font-size: 0.85rem;">
                  {pick.guest.profession}
                </span>
              )}
            </div>
          </div>
          {pick.quote ? (
            <QuoteBlock
              quote={pick.quote}
              attribution={`${pick.guest?.name || pick.guest_slug}`}
              timestampUrl={pick.youtube_timestamp_url || pick.vimeo_timestamp_url}
            />
          ) : (
            <p class="text-muted" style="font-style: italic; margin-top: 0.25rem;">Picked without comment</p>
          )}
        </div>
      ))}
    </div>

    {boxSetInfo.map((bs) => {
      const bsPicks = boxSetPicks.filter(p => p.box_set_name === bs.name);
      const noQuoteGuests = bs.guest_slugs.map(s => getGuestBySlug(s)).filter(Boolean);
      const totalBoxSetGuests = bsPicks.length + bs.guest_count;
      return totalBoxSetGuests > 0 ? (
        <div style="margin-top: 2rem;">
          <h3 style="font-size: 1.1rem;">
            Also mentioned as part of {bs.criterion_url ? (
              <a href={bs.criterion_url} target="_blank" rel="noopener noreferrer">{bs.name}</a>
            ) : bs.name}
          </h3>
          {bsPicks.length > 0 && (
            <div class="picks-list">
              {bsPicks.map((pick) => (
                <div>
                  <div class="pick-guest-header">
                    {pick.guest?.photo_url ? (
                      <img src={pick.guest.photo_url} alt={pick.guest.name} class="guest-photo-small" loading="lazy" />
                    ) : (
                      <div class="guest-initial-small">
                        {pick.guest?.name?.charAt(0) || '?'}
                      </div>
                    )}
                    <div>
                      <a href={`/guests/${pick.guest_slug}/`} style="font-size: 1.05rem;">
                        {pick.guest?.name || pick.guest_slug}
                      </a>
                      {pick.guest?.profession && (
                        <span class="small-caps text-secondary" style="margin-left: 0.5rem; font-size: 0.85rem;">
                          {pick.guest.profession}
                        </span>
                      )}
                    </div>
                  </div>
                  {pick.quote ? (
                    <QuoteBlock
                      quote={pick.quote}
                      attribution={`${pick.guest?.name || pick.guest_slug}`}
                      timestampUrl={pick.youtube_timestamp_url || pick.vimeo_timestamp_url}
                    />
                  ) : (
                    <p class="text-muted" style="font-style: italic; margin-top: 0.25rem;">Picked without comment</p>
                  )}
                </div>
              ))}
            </div>
          )}
          {noQuoteGuests.length > 0 && (
            <details class="box-set-details" style="margin-top: 0.5rem;">
              <summary class="text-muted">
                {bs.guest_count} more {bs.guest_count === 1 ? 'guest' : 'guests'} picked this box set without comment
              </summary>
              <ul class="box-set-film-list" style="margin-top: 0.5rem;">
                {noQuoteGuests.map((g) => (
                  <li><a href={`/guests/${g!.slug}/`}>{g!.name}</a></li>
                ))}
              </ul>
            </details>
          )}
        </div>
      ) : null;
    })}
  </div>
</BaseLayout>
