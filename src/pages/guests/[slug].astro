---
import BaseLayout from '../../layouts/BaseLayout.astro';
import QuoteBlock from '../../components/QuoteBlock.astro';
import { getGuestBySlug, getDisplayablePicksForGuest, getPublishableGuests } from '../../lib/data';
import type { Pick, Film, GuestVisit } from '../../lib/data';

export function getStaticPaths() {
  const guests = getPublishableGuests();
  return guests.map((guest) => ({
    params: { slug: guest.slug },
  }));
}

const { slug } = Astro.params;
const guest = getGuestBySlug(slug!);

if (!guest) {
  return Astro.redirect('/guests/');
}

const picks = getDisplayablePicksForGuest(guest.slug);

const episodeYear = guest.episode_date ? new Date(guest.episode_date).getFullYear() : null;

// Multi-visit support
const visits = guest.visits ?? [];
const isMultiVisit = visits.length >= 2;

// Group picks by visit_index for multi-visit guests
type PickWithFilm = Pick & { film: Film | undefined };
const visitGroups: Map<number, PickWithFilm[]> = new Map();
if (isMultiVisit) {
  for (const pick of picks) {
    const vi = pick.visit_index ?? 1;
    if (!visitGroups.has(vi)) visitGroups.set(vi, []);
    visitGroups.get(vi)!.push(pick);
  }
} else {
  visitGroups.set(1, picks);
}
// Gather all unique links from visits (or fall back to top-level)
const allCriterionUrls = isMultiVisit
  ? visits.map(v => v.criterion_page_url).filter(Boolean) as string[]
  : [guest.criterion_page_url].filter(Boolean) as string[];

// Helper to render a single pick entry
function getVideoEmbed(visit: GuestVisit, label: string, guestName: string) {
  if (visit.youtube_video_id) {
    return { type: 'youtube' as const, id: visit.youtube_video_id, title: `${guestName} - ${label}` };
  }
  if (visit.vimeo_video_id) {
    return { type: 'vimeo' as const, id: visit.vimeo_video_id, title: `${guestName} - ${label}` };
  }
  return null;
}
---
<BaseLayout title={guest.name} description={`${guest.name}'s Criterion Closet Picks — ${picks.length} films picked.`}>
  <div class="detail-page">
    <div class="detail-header">
      {guest.photo_url ? (
        <img src={guest.photo_url} alt={guest.name} class="guest-photo" style="width: 120px; height: 120px;" />
      ) : (
        <div class="guest-initial" style="width: 120px; height: 120px; font-size: 3rem;">
          {guest.name.charAt(0)}
        </div>
      )}
      <div class="detail-meta">
        <h1 style="margin-top: 0;">{guest.name}</h1>
        <p class="small-caps text-secondary" style="margin-bottom: 0.5rem;">
          {guest.profession}
        </p>
        {episodeYear && (
          <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 0.5rem;">
            Episode: {episodeYear}
          </p>
        )}
        <div class="detail-links">
          {!isMultiVisit && (guest.youtube_video_url ? (
            <a href={guest.youtube_video_url} target="_blank" rel="noopener noreferrer">
              Full Video
            </a>
          ) : guest.vimeo_video_id ? (
            <a href={`https://vimeo.com/${guest.vimeo_video_id}`} target="_blank" rel="noopener noreferrer">
              Full Video
            </a>
          ) : null)}
          {allCriterionUrls.map((url, i) => (
            <a href={url} target="_blank" rel="noopener noreferrer">
              {allCriterionUrls.length > 1 ? `Criterion (Visit ${i + 1})` : 'Criterion Page'}
            </a>
          ))}
        </div>
      </div>
    </div>

    {isMultiVisit ? (
      /* Multi-visit layout: group by visit with separate video + picks per visit */
      visits.map((visit, idx) => {
        const vi = idx + 1;
        const visitPicks = visitGroups.get(vi) || [];
        if (visitPicks.length === 0) return null;
        const visitYear = visit?.episode_date ? new Date(visit.episode_date).getFullYear() : null;
        const label = visitYear ? `Visit ${vi} (${visitYear})` : `Visit ${vi}`;
        const embed = getVideoEmbed(visit, label, guest.name);

        return (
          <div class="visit-section">
            <h2>{label} &mdash; {visitPicks.length} Picks</h2>
            {embed?.type === 'youtube' ? (
              <div class="video-embed">
                <iframe
                  src={`https://www.youtube.com/embed/${embed.id}`}
                  title={embed.title}
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                ></iframe>
              </div>
            ) : embed?.type === 'vimeo' ? (
              <div class="video-embed">
                <iframe
                  src={`https://player.vimeo.com/video/${embed.id}`}
                  title={embed.title}
                  allow="autoplay; fullscreen; picture-in-picture"
                  allowfullscreen
                ></iframe>
              </div>
            ) : null}
            {visitPicks.length > 0 && (
              <div class="picks-list">
                {visitPicks.map((pick) => (
                  <div>
                    {pick.box_set_film_count ? (
                      <div class="pick-with-poster">
                        {pick.box_set_criterion_url ? (
                          <a href={pick.box_set_criterion_url} target="_blank" rel="noopener noreferrer" style="border-bottom: none;">
                            {pick.film?.poster_url ? (
                              <img src={pick.film.poster_url} alt={pick.box_set_name} class="film-poster-thumb" loading="lazy" />
                            ) : null}
                          </a>
                        ) : pick.film?.poster_url ? (
                          <img src={pick.film.poster_url} alt={pick.box_set_name} class="film-poster-thumb" loading="lazy" />
                        ) : null}
                        <div class="pick-content">
                          <div class="pick-film-info">
                            {pick.box_set_criterion_url ? (
                              <a href={pick.box_set_criterion_url} class="pick-film-title" target="_blank" rel="noopener noreferrer">
                                {pick.box_set_name}
                              </a>
                            ) : (
                              <span class="pick-film-title">{pick.box_set_name}</span>
                            )}
                            {pick.box_set_film_count > 0 && (
                              <span class="pick-film-meta">
                                {' '}&mdash; {pick.box_set_film_count} films
                              </span>
                            )}
                            <span class="box-set-tag">Box Set</span>
                            {pick.box_set_film_titles && (
                              <details class="box-set-details">
                                <summary class="text-muted">Show films</summary>
                                <ul class="box-set-film-list">
                                  {pick.box_set_film_titles.map((title: string) => (
                                    <li>{title}</li>
                                  ))}
                                </ul>
                              </details>
                            )}
                          </div>
                          {pick.quote && (
                            <QuoteBlock
                              quote={pick.quote}
                              timestampUrl={pick.youtube_timestamp_url || pick.vimeo_timestamp_url}
                              hideAttribution={true}
                            />
                          )}
                        </div>
                      </div>
                    ) : (
                      <div class="pick-with-poster">
                        <a href={`/films/${pick.film_slug}/`} style="border-bottom: none;">
                          {pick.film?.poster_url ? (
                            <img src={pick.film.poster_url} alt={pick.film?.title} class="film-poster-thumb" loading="lazy" />
                          ) : pick.film?.criterion_spine_number ? (
                            <div class="spine-placeholder-thumb">
                              #{pick.film.criterion_spine_number}
                            </div>
                          ) : null}
                        </a>
                        <div class="pick-content">
                          <div class="pick-film-info">
                            <a href={`/films/${pick.film_slug}/`} class="pick-film-title">
                              {pick.film?.title || pick.film_slug}
                            </a>
                            {pick.film && (
                              <span class="pick-film-meta">
                                {pick.film.director ? ` — ${pick.film.director}` : ''}{pick.film.year ? `, ${pick.film.year}` : ''}
                                {pick.film.criterion_spine_number && (
                                  <span> &middot; <span class="spine-number">#{pick.film.criterion_spine_number}</span></span>
                                )}
                              </span>
                            )}
                            {pick.is_box_set && pick.box_set_name && (
                              <span class="box-set-tag">Part of {pick.box_set_name}</span>
                            )}
                          </div>
                          {pick.quote ? (
                            <QuoteBlock
                              quote={pick.quote}
                              timestampUrl={pick.youtube_timestamp_url || pick.vimeo_timestamp_url}
                              hideAttribution={true}
                            />
                          ) : (
                            <p class="text-muted" style="font-style: italic; margin-top: 0.25rem;">Picked without comment</p>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      })
    ) : (
      /* Single-visit layout */
      <Fragment>
        {guest.youtube_video_id ? (
          <div class="video-embed">
            <iframe
              src={`https://www.youtube.com/embed/${guest.youtube_video_id}`}
              title={`${guest.name} - Criterion Closet Picks`}
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>
        ) : guest.vimeo_video_id ? (
          <div class="video-embed">
            <iframe
              src={`https://player.vimeo.com/video/${guest.vimeo_video_id}`}
              title={`${guest.name} - Criterion Closet Picks`}
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>
        ) : null}

        <h2>{picks.length} Picks</h2>

        {picks.length > 0 && (
          <div class="picks-list">
            {picks.map((pick) => (
              <div>
                {pick.box_set_film_count ? (
                  <div class="pick-with-poster">
                    {pick.box_set_criterion_url ? (
                      <a href={pick.box_set_criterion_url} target="_blank" rel="noopener noreferrer" style="border-bottom: none;">
                        {pick.film?.poster_url ? (
                          <img src={pick.film.poster_url} alt={pick.box_set_name} class="film-poster-thumb" loading="lazy" />
                        ) : null}
                      </a>
                    ) : pick.film?.poster_url ? (
                      <img src={pick.film.poster_url} alt={pick.box_set_name} class="film-poster-thumb" loading="lazy" />
                    ) : null}
                    <div class="pick-content">
                      <div class="pick-film-info">
                        {pick.box_set_criterion_url ? (
                          <a href={pick.box_set_criterion_url} class="pick-film-title" target="_blank" rel="noopener noreferrer">
                            {pick.box_set_name}
                          </a>
                        ) : (
                          <span class="pick-film-title">{pick.box_set_name}</span>
                        )}
                        {pick.box_set_film_count > 0 && (
                          <span class="pick-film-meta">
                            {' '}&mdash; {pick.box_set_film_count} films
                          </span>
                        )}
                        <span class="box-set-tag">Box Set</span>
                        {pick.box_set_film_titles && (
                          <details class="box-set-details">
                            <summary class="text-muted">Show films</summary>
                            <ul class="box-set-film-list">
                              {pick.box_set_film_titles.map((title: string) => (
                                <li>{title}</li>
                              ))}
                            </ul>
                          </details>
                        )}
                      </div>
                      {pick.quote && (
                        <QuoteBlock
                          quote={pick.quote}
                          timestampUrl={pick.youtube_timestamp_url || pick.vimeo_timestamp_url}
                          hideAttribution={true}
                        />
                      )}
                    </div>
                  </div>
                ) : (
                  <div class="pick-with-poster">
                    <a href={`/films/${pick.film_slug}/`} style="border-bottom: none;">
                      {pick.film?.poster_url ? (
                        <img src={pick.film.poster_url} alt={pick.film.title} class="film-poster-thumb" loading="lazy" />
                      ) : pick.film?.criterion_spine_number ? (
                        <div class="spine-placeholder-thumb">
                          #{pick.film.criterion_spine_number}
                        </div>
                      ) : null}
                    </a>
                    <div class="pick-content">
                      <div class="pick-film-info">
                        <a href={`/films/${pick.film_slug}/`} class="pick-film-title">
                          {pick.film?.title || pick.film_slug}
                        </a>
                        {pick.film && (
                          <span class="pick-film-meta">
                            {pick.film.director ? ` — ${pick.film.director}` : ''}{pick.film.year ? `, ${pick.film.year}` : ''}
                            {pick.film.criterion_spine_number && (
                              <span> &middot; <span class="spine-number">#{pick.film.criterion_spine_number}</span></span>
                            )}
                          </span>
                        )}
                        {pick.is_box_set && pick.box_set_name && (
                          <span class="box-set-tag">Part of {pick.box_set_name}</span>
                        )}
                      </div>
                      {pick.quote ? (
                        <QuoteBlock
                          quote={pick.quote}
                          timestampUrl={pick.youtube_timestamp_url || pick.vimeo_timestamp_url}
                          hideAttribution={true}
                        />
                      ) : (
                        <p class="text-muted" style="font-style: italic; margin-top: 0.25rem;">Picked without comment</p>
                      )}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {picks.length === 0 && (
          <p class="text-muted">No picks data available for this guest.</p>
        )}
      </Fragment>
    )}
  </div>
</BaseLayout>
