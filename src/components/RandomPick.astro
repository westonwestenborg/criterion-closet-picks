---
import { getFilms, getPicks, getGuests } from '../lib/data';

const films = getFilms();
const picks = getPicks();
const guests = getGuests();

// Build a serializable data structure for client-side JS
const randomData = picks
  .filter(p => p.quote && !p.box_set_film_count)
  .map(p => {
    const film = films.find(f => f.slug === p.film_slug);
    const guest = guests.find(g => g.slug === p.guest_slug);
    return {
      filmTitle: film?.title || '',
      filmSlug: film?.slug || '',
      filmDirector: film?.director || '',
      filmYear: film?.year || 0,
      posterUrl: film?.poster_url || '',
      criterionUrl: film?.criterion_url || '',
      tmdbUrl: film?.tmdb_url || '',
      spineNumber: film?.criterion_spine_number || null,
      guestName: guest?.name || '',
      guestSlug: guest?.slug || '',
      quote: p.quote,
      timestampUrl: p.youtube_timestamp_url,
    };
  });

// Pick one at build time for initial render (SSG)
const initialPick = randomData.length > 0
  ? randomData[Math.floor(Math.random() * randomData.length)]
  : null;
---
<div class="random-container" style="text-align: left; max-width: 650px;">
  <div class="random-result" id="random-result">
    {initialPick && (
      <Fragment>
        <h3 style="margin-top: 0;">
          <a href={`/films/${initialPick.filmSlug}/`}>{initialPick.filmTitle}</a>
        </h3>
        <p class="text-secondary" style="font-size: 0.9rem; margin-bottom: 0.75rem;">
          {initialPick.filmDirector ? `${initialPick.filmDirector}, ${initialPick.filmYear}` : initialPick.filmYear}
        </p>
        {initialPick.posterUrl ? (
          <img src={initialPick.posterUrl} alt={initialPick.filmTitle} class="film-poster" loading="lazy" style="max-width: 185px;" />
        ) : initialPick.spineNumber ? (
          <div class="spine-placeholder">#{initialPick.spineNumber}</div>
        ) : null}
        {(initialPick.criterionUrl || initialPick.tmdbUrl) && (
          <div class="detail-links" style="margin-bottom: 0.75rem;">
            {initialPick.criterionUrl && (
              <a href={initialPick.criterionUrl} target="_blank" rel="noopener noreferrer">Criterion</a>
            )}
            {initialPick.tmdbUrl && (
              <a href={initialPick.tmdbUrl} target="_blank" rel="noopener noreferrer">TMDB</a>
            )}
          </div>
        )}
        <blockquote>
          {initialPick.timestampUrl ? (
            <a href={initialPick.timestampUrl} class="quote-link" target="_blank" rel="noopener noreferrer">
              <p>&ldquo;{initialPick.quote}&rdquo;</p>
            </a>
          ) : (
            <p>&ldquo;{initialPick.quote}&rdquo;</p>
          )}
        </blockquote>
        <p class="quote-attribution">
          &mdash; <a href={`/guests/${initialPick.guestSlug}/`}>{initialPick.guestName}</a>
        </p>
      </Fragment>
    )}
  </div>
  <div style="margin-top: 2rem;">
    <button class="random-button" id="random-pick-btn">Another</button>
  </div>
</div>

<script define:vars={{ randomData }}>
  function renderPick(pick) {
    const result = document.getElementById('random-result');
    if (!result) return;

    const directorYear = pick.filmDirector
      ? `${pick.filmDirector}, ${pick.filmYear}`
      : pick.filmYear;

    const quoteHtml = pick.timestampUrl
      ? `<a href="${pick.timestampUrl}" class="quote-link" target="_blank" rel="noopener noreferrer"><p>\u201C${pick.quote}\u201D</p></a>`
      : `<p>\u201C${pick.quote}\u201D</p>`;

    let posterHtml = '';
    if (pick.posterUrl) {
      posterHtml = `<img src="${pick.posterUrl}" alt="${pick.filmTitle}" class="film-poster" loading="lazy" style="max-width: 185px;" />`;
    } else if (pick.spineNumber) {
      posterHtml = `<div class="spine-placeholder">#${pick.spineNumber}</div>`;
    }

    let linksHtml = '';
    if (pick.criterionUrl || pick.tmdbUrl) {
      const criterionLink = pick.criterionUrl ? `<a href="${pick.criterionUrl}" target="_blank" rel="noopener noreferrer">Criterion</a>` : '';
      const tmdbLink = pick.tmdbUrl ? `<a href="${pick.tmdbUrl}" target="_blank" rel="noopener noreferrer">TMDB</a>` : '';
      linksHtml = `<div class="detail-links" style="margin-bottom: 0.75rem;">${criterionLink}${tmdbLink}</div>`;
    }

    result.innerHTML = `
      <h3 style="margin-top: 0;">
        <a href="/films/${pick.filmSlug}/">${pick.filmTitle}</a>
      </h3>
      <p class="text-secondary" style="font-size: 0.9rem; margin-bottom: 0.75rem;">
        ${directorYear}
      </p>
      ${posterHtml}
      ${linksHtml}
      <blockquote>
        ${quoteHtml}
      </blockquote>
      <p class="quote-attribution">
        &mdash; <a href="/guests/${pick.guestSlug}/">${pick.guestName}</a>
      </p>
    `;
  }

  const btn = document.getElementById('random-pick-btn');
  btn?.addEventListener('click', () => {
    if (randomData.length === 0) return;
    const pick = randomData[Math.floor(Math.random() * randomData.length)];
    renderPick(pick);
  });
</script>
